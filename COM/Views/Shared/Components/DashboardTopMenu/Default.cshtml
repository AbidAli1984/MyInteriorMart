@inject IUsersOnlineRepository userOnlineRepo
@inject IUserProfileRepo userProfileRepo
@inject UserManager<IdentityUser> userManager;

@{
    var recent10UnreadNotifications = await userOnlineRepo.GetLatest10UnreadNotificationsOfNotifierAsync(User.Identity.Name);
    var allUnreadNotificationCount = await userOnlineRepo.CountAllUnreadNotificationsOfNotifierAsync(User.Identity.Name);
    var userProfile = await userProfileRepo.GetUserProfileAsync(ViewBag.OwnerGuid);
}

<div class="main-header sticky side-header nav nav-item">
    <div class="container-fluid">
        <div class="main-header-left ">
            <div class="responsive-logo">
                <a href="~/Backend/HTML-LTR/Leftmenu-Closed-Light-Sidebar/index.html"><img src="~/Backend/assets/img/brand/logo.png" class="logo-1" alt="logo"></a>
                <a href="~/Backend/HTML-LTR/Leftmenu-Closed-Light-Sidebar/index.html"><img src="~/Backend/assets/img/brand/logo-white.png" class="dark-logo-1" alt="logo"></a>
                <a href="~/Backend/HTML-LTR/Leftmenu-Closed-Light-Sidebar/index.html"><img src="~/Backend/assets/img/brand/favicon.png" class="logo-2" alt="logo"></a>
                <a href="~/Backend/HTML-LTR/Leftmenu-Closed-Light-Sidebar/index.html"><img src="~/Backend/assets/img/brand/favicon.png" class="dark-logo-2" alt="logo"></a>
            </div>
            <div class="app-sidebar__toggle" data-toggle="sidebar">
                <a class="open-toggle" href="#"><i class="header-icon fe fe-align-left"></i></a>
                <a class="close-toggle" href="#"><i class="header-icons fe fe-x"></i></a>
            </div>
        </div>
        <div class="main-header-right">
            <div class="nav nav-item  navbar-nav-right ml-auto">
                <div class="nav-link" id="bs-example-navbar-collapse-1">
                    <form class="navbar-form" role="search">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search">
                            <span class="input-group-btn">
                                <button type="reset" class="btn btn-default">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="submit" class="btn btn-default nav-link resp-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svgs" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                </button>
                            </span>
                        </div>
                    </form>
                </div>
                <div class="dropdown nav-item main-header-message ">
                    <a class="new nav-link" href="#"><svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svgs" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><span class=" pulse-danger"></span></a>
                    <div class="dropdown-menu">
                        <div class="menu-header-content bg-primary text-left">
                            <div class="d-flex">
                                <h6 class="dropdown-title mb-1 tx-15 text-white font-weight-semibold">Messages</h6>
                                <span class="badge badge-pill badge-warning ml-auto my-auto float-right">Mark All Read</span>
                            </div>
                            <p class="dropdown-title-text subtext mb-0 text-white op-6 pb-0 tx-12 ">You have 4 unread messages</p>
                        </div>
                        <div class="main-message-list chat-scroll">
                            <a href="#" class="p-3 d-flex border-bottom">
                                <div class="  drop-img  cover-image  " data-image-src="../../assets/img/faces/3.jpg">
                                    <span class="avatar-status bg-teal"></span>
                                </div>
                                <div class="wd-90p">
                                    <div class="d-flex">
                                        <h5 class="mb-1 name">Petey Cruiser</h5>
                                    </div>
                                    <p class="mb-0 desc">I'm sorry but i'm not sure how to help you with that......</p>
                                    <p class="time mb-0 text-left float-left ml-2 mt-2">Mar 15 3:55 PM</p>
                                </div>
                            </a>
                            <a href="#" class="p-3 d-flex border-bottom">
                                <div class="drop-img cover-image" data-image-src="../../assets/img/faces/2.jpg">
                                    <span class="avatar-status bg-teal"></span>
                                </div>
                                <div class="wd-90p">
                                    <div class="d-flex">
                                        <h5 class="mb-1 name">Jimmy Changa</h5>
                                    </div>
                                    <p class="mb-0 desc">All set ! Now, time to get to you now......</p>
                                    <p class="time mb-0 text-left float-left ml-2 mt-2">Mar 06 01:12 AM</p>
                                </div>
                            </a>
                            <a href="#" class="p-3 d-flex border-bottom">
                                <div class="drop-img cover-image" data-image-src="../../assets/img/faces/9.jpg">
                                    <span class="avatar-status bg-teal"></span>
                                </div>
                                <div class="wd-90p">
                                    <div class="d-flex">
                                        <h5 class="mb-1 name">Graham Cracker</h5>
                                    </div>
                                    <p class="mb-0 desc">Are you ready to pickup your Delivery...</p>
                                    <p class="time mb-0 text-left float-left ml-2 mt-2">Feb 25 10:35 AM</p>
                                </div>
                            </a>
                            <a href="#" class="p-3 d-flex border-bottom">
                                <div class="drop-img cover-image" data-image-src="../../assets/img/faces/12.jpg">
                                    <span class="avatar-status bg-teal"></span>
                                </div>
                                <div class="wd-90p">
                                    <div class="d-flex">
                                        <h5 class="mb-1 name">Donatella Nobatti</h5>
                                    </div>
                                    <p class="mb-0 desc">Here are some products ...</p>
                                    <p class="time mb-0 text-left float-left ml-2 mt-2">Feb 12 05:12 PM</p>
                                </div>
                            </a>
                            <a href="#" class="p-3 d-flex border-bottom">
                                <div class="drop-img cover-image" data-image-src="../../assets/img/faces/5.jpg">
                                    <span class="avatar-status bg-teal"></span>
                                </div>
                                <div class="wd-90p">
                                    <div class="d-flex">
                                        <h5 class="mb-1 name">Anne Fibbiyon</h5>
                                    </div>
                                    <p class="mb-0 desc">I'm sorry but i'm not sure how...</p>
                                    <p class="time mb-0 text-left float-left ml-2 mt-2">Jan 29 03:16 PM</p>
                                </div>
                            </a>
                        </div>
                        <div class="text-center dropdown-footer">
                            <a href="~/Backend/HTML-LTR/Leftmenu-Closed-Light-Sidebar/text-center">VIEW ALL</a>
                        </div>
                    </div>
                </div>
                <div class="dropdown nav-item main-header-notification">
                    <a class="new nav-link" href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell header-icon-svgs"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <!-- Shafi: SignalR used to hide and show this span -->
                        <span id="notificationPulse" class="pulse"></span>
                        <!-- End: -->
                    </a>
                    <div class="dropdown-menu">
                        <div class="menu-header-content bg-primary text-left">
                            <div class="d-flex">
                                <h6 class="dropdown-title mb-1 tx-15 text-white font-weight-semibold">Notifications</h6>
                                <a href="#0" class="badge badge-pill badge-warning ml-auto my-auto float-right" id="markAllAsReadBtn">Mark All Read</a>
                                <!-- Shafi: Show or hide via ajax -->
                                <a href="#0" class="badge badge-pill badge-info ml-auto my-auto float-right" id="markAllAsUnreadBtn">Mark All As Unread</a>
                                <!-- End: -->
                            </div>
                            <p class="dropdown-title-text subtext mb-0 text-white op-6 pb-0 tx-12 ">You have <span id="unreadNotificationCount">@allUnreadNotificationCount</span> unread Notifications</p>
                        </div>
                        <style>
                            .Notification-scroll {
                                overflow: scroll;
                            }
                        </style>

                        <!-- Shafi: SignalR append notifications here -->
                        <div id="appendNotifications" class="main-notification-list Notification-scroll">
                            @foreach (var notification in recent10UnreadNotifications)
                            {
                                DateTime currentDate = DateTime.Now;
                                TimeSpan timeSpan = currentDate.Subtract(notification.DateTime);
                                var notificationTime = DateTime.UtcNow.AddMinutes(-timeSpan.TotalMinutes).Humanize();
                                var actorProfile = await userProfileRepo.GetUserProfileAsync(notification.ActorGUID);

                                // If actorProfile is not null then execute this
                                string actorName = "";
                                string actorProfileImage = "";

                                if (actorProfile != null)
                                {
                                    actorName = actorProfile.Name;
                                    actorProfileImage = $"/FileManager/ProfileImages/{actorProfile.ProfileID.ToString()}.jpg";
                                }
                                else
                                {
                                    actorName = "Unkown Person";
                                    actorProfileImage = $"/img/profile-thumbnail.jpg";
                                }
                                // End:

                                // Shafi: Set icons
                                string icon = "";
                                if (notification.EntityType == "LISTING" && notification.Action == "Liked")
                                {
                                    icon = "/icons-notification-green/like.png";
                                }
                                if (notification.EntityType == "LISTING" && notification.Action == "Unliked")
                                {
                                    icon = "/icons-notification-red/unlike.png";
                                }
                                // End:

                                // Shafi: Check if actorIsOnline
                                var userActor = await userManager.FindByIdAsync(notification.ActorGUID);
                                var actorOnline = await userOnlineRepo.CheckIfUserOnlineByUserID(userActor.Email);
                                // End:

                                // Shafi: Set toggle image ID
                                string toggleButtonId = notification.ListingNotificationID + "-toggleButton";
                                // End:

                                <div class='d-flex justify-content-between border-top'><div class='p-2'><a href=''><div class='main-avatar avatar @(actorOnline == true ? "online" : "offline" )'><img alt='avatar' class='rounded-circle avatar' src='@actorProfileImage'></div></a></div> <div class='p-2'> <strong><a href=''>@actorName</a></strong><p>@Html.Raw(notification.Description)<br /><span>@notificationTime</span></p></div> <div class='p-2'> <div class='d-flex flex-column'><div class='p-1'><a href='#0' class='markAsRead' onclick="toggleFunction(@notification.ListingNotificationID)"><img src='/icons-notification-green/switch.png' id="@toggleButtonId" width='20' class='float-right imgNotificationAjax' data-notificationId="@notification.ListingNotificationID" /></a></div><div class='p-1 mt-2'><img src='@icon' width='20' class='float-right' /></div></div></div></div>
                                <input type="hidden" class="getListOfListingNotifictaionIds" value="@notification.ListingNotificationID" />
                            }
                        </div>
                        <!-- End: -->

                        <div class="dropdown-footer">
                            <a href="">VIEW ALL</a>
                        </div>
                    </div>
                </div>
                <div class="nav-item full-screen fullscreen-button">
                    <a class="new nav-link full-screen-link" href="#"><svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svgs" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg></a>
                </div>
                <div class="dropdown main-profile-menu nav nav-item nav-link">
                    @if (userProfile != null)
                    {
                        // Begin: Get profile image
                        var profileImage = userProfile.ProfileID + ".jpg";
                        // End:
                        <a class="profile-user d-flex" href=""><img alt="" src="~/FileManager/ProfileImages/@profileImage" style="border:1px solid #e0e0e0;"></a>
                    }
                    else
                    {
                        <div class="main-img-user"><img alt="" src="~/Backend/assets/img/faces/6.jpg" class=""></div>
                    }
                    <div class="dropdown-menu">
                        <div class="main-header-profile bg-primary p-3">
                            <div class="d-flex wd-100p">
                                @if (userProfile != null)
                                {
                                    // Begin: Get profile image
                                    var profileImage = userProfile.ProfileID + ".jpg";
                                    // End:
                                    <div class="main-img-user"><img alt="" src="~/FileManager/ProfileImages/@profileImage" class=""></div>
                                }
                                else
                                {
                                    <div class="main-img-user"><img alt="" src="~/Backend/assets/img/faces/6.jpg" class=""></div>
                                }
                                <div class="ml-3 my-auto">
                                    @if (userProfile != null)
                                    {
                                        <h6>@userProfile.Name</h6>
                                    }
                                    else
                                    {
                                        <h6>Create Profile</h6>
                                    }
                                    <span>@User.Identity.Name</span>
                                </div>
                            </div>
                        </div>
                        <a class="dropdown-item" href="~/Profile/UserProfile/Index"><i class="bx bx-user-circle"></i>Profile</a>
                        <a class="dropdown-item" href="~/Identity/Account/Manage/Index"><i class="bx bx-cog"></i> Settings</a>
                        <a class="dropdown-item" href=""><i class="bx bxs-inbox"></i>Inbox</a>
                        <a class="dropdown-item" href=""><i class="bx bx-envelope"></i>Messages</a>
                        <a class="dropdown-item" href=""><i class="bx bx-slider-alt"></i> Account Settings</a>
                        <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                            <a href="" class="dropdown-item" onclick="this.closest('form').submit();return false;" title="Logout" style="color:#383838;"><i class="bx bx-log-out"></i> Sign Out</a>
                        </form>
                    </div>
                </div>
                <div class="dropdown main-header-message right-toggle">
                    <a class="nav-link pr-0" data-toggle="sidebar-right" data-target=".sidebar-right">
                        <svg xmlns="http://www.w3.org/2000/svg" class="header-icon-svgs" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>